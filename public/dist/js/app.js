function init(e){sampleRate=e.sampleRate}function record(e){recBuffersL.push(e[0]),recBuffersR.push(e[1]),recLength+=e[0].length}function exportWAV(e){var t=mergeBuffers(recBuffersL,recLength),n=mergeBuffers(recBuffersR,recLength),o=interleave(t,n),r=encodeWAV(o),i=new Blob([r],{type:e});this.postMessage(i)}function getBuffer(){var e=[];e.push(mergeBuffers(recBuffersL,recLength)),e.push(mergeBuffers(recBuffersR,recLength)),this.postMessage(e)}function clear(){recLength=0,recBuffersL=[],recBuffersR=[]}function mergeBuffers(e,t){for(var n=new Float32Array(t),o=0,r=0;r<e.length;r++)n.set(e[r],o),o+=e[r].length;return n}function interleave(e,t){for(var n=e.length+t.length,o=new Float32Array(n),r=0,i=0;n>r;)o[r++]=e[i],o[r++]=t[i],i++;return o}function floatTo16BitPCM(e,t,n){for(var o=0;o<n.length;o++,t+=2){var r=Math.max(-1,Math.min(1,n[o]));e.setInt16(t,0>r?32768*r:32767*r,!0)}}function writeString(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}function encodeWAV(e){var t=new ArrayBuffer(44+2*e.length),n=new DataView(t);return writeString(n,0,"RIFF"),n.setUint32(4,32+2*e.length,!0),writeString(n,8,"WAVE"),writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,2,!0),n.setUint32(24,sampleRate,!0),n.setUint32(28,4*sampleRate,!0),n.setUint16(32,4,!0),n.setUint16(34,16,!0),writeString(n,36,"data"),n.setUint32(40,2*e.length,!0),floatTo16BitPCM(n,44,e),n}var app=angular.module("cippy",["partials","ngSanitize","ui.router","satellizer"]);app.config(["$stateProvider","$urlRouterProvider","$authProvider",function(e,t,n){n.facebook({clientId:"468348829982756"}),t.otherwise("/home"),e.state("home",{url:"/home",templateUrl:"partials/home.html",controller:"HomeController"}).state("logout",{url:"/logout",template:null,controller:"LogoutController"}).state("project",{url:"/project",templateUrl:"partials/project.html",controller:"ProjectController"}).state("editor",{url:"/editor/:arrangement_id",templateUrl:"partials/editor.html",controller:"EditorController",resolve:{authenticated:["$q","$location","$auth",function(e,t,n){var o=e.defer();return n.isAuthenticated()?o.resolve():t.path("/home"),o.promise}]}}).state("editor_test",{url:"/editor_test/:arrangement_id",templateUrl:"partials/editor.html",controller:"EditorController"})}]),app.constant("CouchURL","http://localhost:5984/"),app.constant("_ArrangementDB","cippy_arrangements"),app.constant("_ChatDB","cippy_chats"),app.constant("_UserDB","cippy_users"),app.constant("_SharedDB","cippy_shared"),app.constant("_ProjectDB","cippy_projects"),app.constant("FBClientId","468348829982756"),app.factory("BaseAudioNode",[function(){return Class.extend({constructor:function(e){this.gain=1,this.data=e},length:function(){return 0}})}]),app.factory("BufferedNode",["BaseAudioNode","BufferLoader","$q","Arrangement",function(e,t,n,o){return e.extend({constructor:function(e){this.data=e,this.buffer=void 0,this.source=void 0},length:function(){return this.buffer?this.data.offsetStart||this.data.offsetEnd?this.buffer.duration-this.data.offsetStart-this.data.offsetEnd:this.buffer.duration:0},fetch:function(){var e=n.defer();if(this.buffer)e.resolve(this.buffer);else{var r=o.getBufferFromId(this.data.buffer_id),i=t.load(r);i.then(function(t){this.buffer=t,e.resolve(t)}.bind(this))}return e.promise},isPlaying:function(){var e=this.source;return e&&e.playbackState==e.PLAYING_STATE},play:function(e,t,n){e||(e=0),t||(t=0);var o=this.master,r=this.context,i=r.createBufferSource(),a=r.createGain();i.buffer=this.buffer,i.connect(a),a.connect(o),a.gain.value=_.isNumber(this.data.gain)?this.data.gain:1;var c=this.length();return e=void 0!=n?n:r.currentTime+e,i.start(e,t+(this.data.offsetStart||0),c),this.source=i,i},stop:function(){try{this.source.stop(0)}catch(e){}}})}]),app.factory("BufferedRecordingNode",["BufferedNode","BufferLoader","$q","SharedAudioContext","Arrangement",function(e,t,n,o){return e.extend({constructor:function(e,t){this.data=e,this.buffer=t,this.source=void 0,this.bufferOffsetStart=0,this.context=o.getContext(),this.master=this.context.destination},fetch:function(){var e=n.defer();return e.resolve(this.buffer),e.promise}})}]),app.factory("Pattern",["BufferedRecordingNode","$q","BufferedNode","Ticker","Drumkits","SharedAudioContext",function(e,t,n,o,r,i){return Class.extend({constructor:function(e,t){this.data=e,this.sampler=t,this.scheduledSounds=[],this.reset()},reset:function(){this.currentSlot=-1,this.nextBeatScheduledFor=0,this.scheduledSounds.forEach(function(e){e.stop()}),this.scheduledSounds=[]},hasMoreBeats:function(){return this.currentSlot<this.data.slots-1},length:function(){return this.data.slots*this.secondsBetweenBeats()},secondsBetweenBeats:function(){return 60/this.data.bpm/4},schedule:function(e){for(var t=r.instrumentsForKit(this.sampler.data.drumType),n=this.secondsBetweenBeats(),o=0;o<t.length;o++){var i=t[o];if(this.data.beats[i])for(var a=e,c=0;c<this.data.slots;c++)a+=n,this.data.beats[i][c]&&c>=this.currentSlot&&this.scheduledSounds.push(r.play(this.sampler.data.drumType,i,this.sampler.master,null,null,a))}},loop:function(e){this.ticker=new o,this.ticker.interval=30;var t=i.getContext(),n=t.currentTime,a=-1,c=.1;this.ticker.callback=function(){n<=t.currentTime+c&&(a+=1,a>=this.data.slots&&(a=0),n+=this.secondsBetweenBeats(),r.instrumentsForKit(this.sampler.data.drumType).forEach(function(e){this.data.beats[e][a]&&r.play(this.sampler.data.drumType,e,this.sampler.master,null,null,n-c)}.bind(this)),e(a))}.bind(this),this.ticker.start()},stopLoop:function(){this.ticker&&this.ticker.stop()}})}]),app.factory("Sampler",["$q","$timeout","BaseAudioNode","Ticker","SharedAudioContext","BufferedNode","Pattern",function(e,t,n,o,r,i,a){return n.extend({currentPattern:null,patternOrderPosition:0,lookAhead:.1,constructor:function(e){this.data=e,this.createPatterns(),this.resetCurrentPattern(),this.ticker=new o,this.ticker.interval=100,this.ticker.callback=this.ontick.bind(this)},createPatterns:function(){Object.keys(this.data.patterns).forEach(function(e){this[e]=new a(this.data.patterns[e],this),this[e].context=this.context,this[e].master=this.master}.bind(this))},resetCurrentPattern:function(){this.currentPatternIndex=0,this.currentPattern=this[this.data.patternOrder[this.currentPatternIndex]]},nextPatternStartTime:function(){for(var e=(this.currentPatternIndex+1,0),t=0;t<this.currentPatternIndex;t++){var n=this[this.data.patternOrder[t]];e+=n.length()}return this.startedAtWithoutOffset+e},scheduleNextPattern:function(e){this.currentPattern.schedule(e),this.currentPattern.scheduled=!0,this.currentPatternIndex++,this.currentPattern=this[this.data.patternOrder[this.currentPatternIndex]]},ontick:function(){var e=this.context.currentTime;if(this.hasNextPattern())e+this.lookAhead>this.nextPatternStartTime()&&(this.scheduleNextPattern(this.nextPatternStartTime()),this.offsetCalculated&&(this.currentPattern.currentSlot=0,this.offsetCalculated=!1));else{this.ticker.stop();var t=1e3*this.length();this.stopTimeout=setTimeout(this.stop.bind(this),t)}},hasNextPattern:function(){return this.currentPattern&&!this.currentPattern.scheduled||this.currentPatternIndex<this.data.patternOrder.length},length:function(){var e=0;return this.forEachPatternInOrder(function(t){e+=t.length()}),e},play:function(e,t){this.startedAt=this.context.currentTime+e,this.startedAtWithoutOffset=this.startedAt-t,this.offset=t,this.currentPattern||this.resetCurrentPattern(),t>0&&(this.offsetCalculated=!0,this.calculateOffset(t)),this.ticker.start()},stop:function(){clearTimeout(this.stopTimeout),this.ticker.stop(),this.forEachPattern(function(e){e.reset(),e.scheduled=!1}),this.resetCurrentPattern()},forEachPattern:function(e){for(var t in this.data.patterns){var n=e(this[t]);if(n===!1)break}},forEachPatternInOrder:function(e){for(var t=0;t<this.data.patternOrder.length;t++){var n=e(this[this.data.patternOrder[t]],t);if(n===!1)break}},calculateOffset:function(e){var t=0,n=null,o=0;this.forEachPatternInOrder(function(r,i){t+=r.length();var a=r.length();return t+a>e?(n=r,o=i,!1):void(t+=a)}),this.currentPattern=n,this.currentPatternIndex=o;var r=Math.ceil((e-(t-n.length()))/this.currentPattern.secondsBetweenBeats());this.currentPattern.currentSlot=r-1}})}]),app.factory("Synthesizer",["BaseAudioNode","BufferLoader","$q","Arrangement",function(e){var t=function(e){var t=e.createOscillator(),n=e.createGain();return t.connect(n),{osc:t,gain:n}};return e.extend({oscillatorTypes:["sine","square","sawtooth","triangle"],filterTypes:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"],notes:["A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4"],constructor:function(e){this.playingNotes={},this.data=e},setup:function(){this.setupNodes(),this.setupSettings(),this.wireUpNodes()},setupNodes:function(){this.lfo=this.context.createOscillator(),this.lfo.start(0),this.compressor=this.context.createDynamicsCompressor(),this.compressor.connect(this.master),this.osc1Gain=this.context.createGain(),this.osc2Gain=this.context.createGain(),this.osc3Gain=this.context.createGain(),this.filter=this.context.createBiquadFilter()},setupSettings:function(){var e=this.data.synthSettings;this.lfo.frequency.value=parseInt(e.lfo.frequency,10),this.lfo.type=e.lfo.type,this.osc1Gain.gain.value=parseFloat(e.osc1.gain),this.osc2Gain.gain.value=parseFloat(e.osc2.gain),this.osc3Gain.gain.value=parseFloat(e.osc3.gain),this.filter.frequency.value=parseInt(e.filter.frequency,10),this.filter.type=e.filter.type},wireUpNodes:function(){this.osc1Gain.disconnect(),this.osc2Gain.disconnect(),this.osc3Gain.disconnect(),this.filter.disconnect(),this.data.synthSettings.filter.activate?(this.osc1Gain.connect(this.filter),this.osc2Gain.connect(this.filter),this.osc3Gain.connect(this.filter),this.filter.connect(this.compressor)):(this.osc1Gain.connect(this.compressor),this.osc2Gain.connect(this.compressor),this.osc3Gain.connect(this.compressor))},setupOscillator:function(e,t){var n=this.data.synthSettings,o=n["osc"+t];e.type=o.type,e.detune.value=parseFloat(o.detune)},wireUpOscillator:function(e,t){e.connect(this["osc"+t+"Gain"])},length:function(){var e=0;return this.data.tones.forEach(function(t){var n=t.position+t.duration;e=n>e?n:e}),e},play:function(e,t){e||(e=0),t||(t=0),this.startedAt=this.context.currentTime+e,this.startedAtWithoutOffset=this.startedAt-t,this.offset=t,console.log("TODO: calculate offset"),this.data.tones.forEach(function(t){var n=e+t.position,o=n+t.duration;this.playNote(t.note,n,o)}.bind(this))},playNote:function(e,n,o){console.log("when",n,"end",o),void 0==n&&(n=0);var r=[t(this.context),t(this.context),t(this.context)],i=this.noteToFrequency(e),a=this.data.synthSettings.toneEnvelope,c=this.context.currentTime,s=c+n,d=void 0!=o?o+c:void 0,l=parseFloat(a.attack),u=parseFloat(a.decay),f=parseFloat(a.release),p=Math.min(parseFloat(a.sustain),1),h=Math.min(p+parseFloat(a.boost),1),m=0,g=0;void 0!=o&&(m=o+c-s,m=m-l-u-f,g=o-n);var v=s+l,y=v+u,w=y+m,k=w+f,S=void 0!=d?v>d:!1,b=void 0!=d?y>d:!1,P=void 0!=d?w>d:!1,_=void 0!=d?k>d:!1;console.log(a.attack,a.decay,g,a.release),console.log(v,y,w,k);for(var $=0;3>$;$++){var C=r[$].osc,E=r[$].gain;if(this.setupOscillator(C,$+1),this.wireUpOscillator(E,$+1),C.frequency.value=i,this.lfo.connect(C.frequency),E.gain.cancelScheduledValues(s),E.gain.setValueAtTime(0,s),S){var A=v-(v-d);E.gain.linearRampToValueAtTime(h,A),E.gain.setValueAtTime(0,A+.01)}else E.gain.linearRampToValueAtTime(h,v);if(S||b){var A=y-(y-d);E.gain.linearRampToValueAtTime(p,A),E.gain.setValueAtTime(0,A+.01)}else E.gain.linearRampToValueAtTime(p,y);if(S||b||P){var A=w-(w-d);E.gain.setValueAtTime(p,A),E.gain.setValueAtTime(0,A+.01)}else E.gain.setValueAtTime(p,w);if(void 0!=o)if(S||b||P||_){var A=k-(k-d);E.gain.setValueAtTime(0,A)}else E.gain.linearRampToValueAtTime(0,k);C.start(s)}this.playingNotes[e]=r},stop:function(){Object.keys(this.playingNotes).forEach(function(e){this.disconnectOscillators(this.playingNotes[e])}.bind(this)),this.playingNotes={}},stopNote:function(e){this.disconnectOscillators(this.playingNotes[e]),delete this.playingNotes[e]},disconnectOscillators:function(e){e&&(e.forEach(function(e){try{e.gain.disconnect(),e.gain=null,e.osc.stop(0),e.osc.disconnect(),e.osc=null}catch(t){console.log("error disconnecting oscillators",t)}}),e=null)},loop:function(){},tonesByNote:function(e){return _.where(this.data.tones,{note:e})},noteToFrequency:function(e){var t,n,o=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"];return n=e.charAt(3===e.length?2:1),t=o.indexOf(e.slice(0,-1)),t=3>t?t+12+12*(n-1)+1:t+12*(n-1)+1,440*Math.pow(2,(t-49)/12)}})}]),app.factory("Track",["BaseAudioNode","Arrangement",function(e,t){return e.extend({constructor:function(e){this.data=e,void 0==this.data.gain&&(this.data.gain=1),this.context=t.context,this["in"]=this.context.createGain(),this["in"].gain.value=this.data.gain,this["in"].connect(t.master)}})}]),app.service("Arrangement",["$rootScope","$q","$state","IDGenerator","BufferUploader","$timeout","SharedAudioContext","$http","CouchURL","_ArrangementDB","$interval","Socket",function(e,t,n,o,r,i,a,c,s,d,l,u){var f={doc:{},offline:{},delta:{},offlineStamp:{},shadow:{},lastRev:{},queue:{},timesock:null,stackCounter:0,onlineState:!0,onlineSync:!0,_rev:"",_pieces:{},getPiece:function(e){return this._pieces[e]},registerPiece:function(e,t){this._pieces[e]=t},unregisterPiece:function(e){delete this._pieces[e]},length:function(){var e=0,t=0;return Object.keys(this._pieces).forEach(function(n){var o=this._pieces[n];t=o.data.position+o.length(),e=t>e?t:e}.bind(this)),e},addTrack:function(e,t){var n={id:o.generate("track"),title:"Untitled",type:e,pieces:[]};this.doc.tracks.push(n),t(n.id)},addBuffer:function(e){this.doc.buffers.push(e)},getBufferFromId:function(e){return _.findWhere(this.doc.buffers,{id:e})},getTrackFromId:function(e){return _.findWhere(this.doc.tracks,{id:e})},addBufferToTrack:function(e,t,n){var o=this.getBufferFromId(e);o&&this._addBufferToTrack(o,t,n)},_addBufferToTrack:function(e,t,n){var r={buffer_id:e.id,type:"buffer",position:n||0,id:o.generate("piece")},a=this.getTrackFromId(t);a&&i(function(){a.pieces.push(r)})},uploadBuffer:function(e){return r.upload(this.doc._id,e).then(function(e){return this.addBuffer(e),e}.bind(this))},uploadBufferAndAddToTrack:function(e,t,n){this.uploadBuffer(e).then(function(e){this._addBufferToTrack(e,t,n)}.bind(this))},removePieceFromTrack:function(e,t){t.pieces=_.without(t.pieces,e)},removeBuffer:function(e){var t=[];this.doc.tracks.forEach(function(n){n.pieces.forEach(function(n){n.buffer_id&&n.buffer_id==e.id&&t.push(n)})});var n="Are you sure you want to delete this file?";t.length&&(n+="\nDeleting this file, will also delete all associated pieces ("+t.length+")!"),confirm(n)&&(this.doc.buffers=_.without(this.doc.buffers,e),t.forEach(function(e){this.doc.tracks.forEach(function(t){t.pieces.forEach(function(n){n==e&&this.removePieceFromTrack(n,t)}.bind(this))}.bind(this))}.bind(this)),c["delete"]("/delete_s3/"+e.id))}};return u.arrangement=f,f.context=a.getContext(),f.master=f.context.createGain(),f.compressor=f.context.createDynamicsCompressor(),f.master.connect(f.compressor),f.compressor.connect(f.context.destination),f.db={},f.checkOffline=function(){var e=t.defer(),n=new PouchDB(s+d);return n.get(f.arrangement_id).then(function(t){return console.log(t.timestamp),console.log("bandingkan offline : retrieved => "+f.offlineStamp+" : "+t.timestamp),e.resolve(f.offlineStamp<t.timestamp)}),e.promise},f.conflict=function(){var e=confirm("This arrangement has a conflict with previous version. Do you want to fork to new arrangement?");if(1==e){var t=f.arrangement_id+"-conflicted-"+moment().format("YYYY-MM-DD-HH:mm:ss");f.db.putIfNotExists({_id:t,title:f.doc.title+"-conflict",author:f.doc.author,buffers:f.doc.buffers,tracks:f.doc.tracks,timestamp:f.doc.timestamp}).then(function(){n.go("editor",{arrangement_id:t})})}else f.delta={}},f.syncing=function(t){function n(){_.isEmpty(f.delta)?(console.log("SYNC REV"),f.doc._rev=t.doc._rev,console.log("::DEBUG:: recivedCouch"),console.log(window.performance.now()+window.performance.timing.navigationStart),e.$apply(function(){if(_.isEmpty(f.queue))console.log("CHECK"),f.temp=!1,f.doc=t.doc;else{var n=angular.copy(f.doc),o=angular.copy(t.doc);delete n._rev,delete o._rev,delete n.temp,delete n.temp,delete n.timestamp,delete o.timestamp;var r=jsondiffpatch.diff(n,o);r||(console.log("CHECK"),f.temp=!1,f.doc=t.doc),f.queue={}}e.arrangement=f.doc})):(console.log("CHECK DELTA IN REPLICATE"),f.checkOffline().then(function(e){e?f.conflict():f.delta={},f.onlineSync=!0}))}f.onlineState=!0,console.log("SYNCING"),console.log(t),t.id==f.arrangement_id&&(f.timesock?t.doc.timestamp>=f.timesock&&(console.log("UPDATE!!!"),n(),f.timesock=null):n(),e.$emit("sync"),e.$emit("synced"),e.$emit("loadWatcher"))},f.goOffline=function(){f.offlineState=!1,f.onlineSync=!1,f.offlineStamp=_.clone(f.doc.timestamp,!0),console.log(f.offlineStamp)},f.push=function(){console.log("PUT SENDING");var e=f.doc;delete e._rev,delete e._id,delete e.temp,delete e.timesock,f.db.upsert(f.arrangement_id,function(){return e}).then(function(){})["catch"](function(){console.log("failed to update")})},f.goOnline=function(){f.offlineState=!0},f.sync=function(){var e={live:!0,retry:!0,since:"now",include_docs:!0,conflicts:!0};f.db.sync(s+d,e)},f.init=function(){f.db=new PouchDB(d,{auto_compaction:!0}),console.log(f.arrangement_id);var t=function(){console.log("::DEBUG:: init"),console.log(window.performance.now()+window.performance.timing.navigationStart),f.db.get(f.arrangement_id).then(function(t){console.log("::DEBUG:: loaded"),console.log(window.performance.now()+window.performance.timing.navigationStart),console.log(t),e.$apply(function(){f.doc=t,e.arrangement=f.doc}),e.$emit("sync"),e.$emit("synced"),e.$emit("loadWatcher")})["catch"](function(e){console.log(e);var t={_id:f.arrangement_id,tracks:[],buffers:[],author:"",title:"Untitled"};f.db.putIfNotExists(f.arrangement_id,t)})};f.db.replicate.from(s+d).then(t)["catch"](t),f.db.changes({live:!0,retry:!0,since:"now",include_docs:!0,conflicts:!0}).on("change",f.syncing),f.sync()},f.retrieve=function(){return f.db.get(f.arrangement_id)},u.socket.on("replicate",function(t){console.log("===STREAM COMING==="),t._id==f.arrangement_id&&f.onlineState&&f.onlineSync&&(_.isEmpty(f.delta)?(console.log("::DEBUG:: recivedSocket"),console.log(window.performance.now()+window.performance.timing.navigationStart),console.log("UPDATE SOCKET"),jsondiffpatch.patch(f.doc,t.delta),f.timesock=t.timesock,f.timestamp=t.timesock,e.$apply(function(){e.arrangement=f.doc}),e.$emit("sync"),e.$emit("synced"),e.$emit("loadWatcher")):(console.log("CHECK DELTA IN SOCKET"),f.checkOffline().then(function(e){e&&f.conflict()})))}),f.watchComponent=function(e,t){var n=e,o=n._rev;f.queue=t,u.socket.emit("replicate",{_id:n._id,delta:t,timesock:o}),delete n._rev,delete n._id,delete n.temp,delete n.timesock,n.timestamp=o,console.log("PUT SENDING"),console.log("::DEBUG:: sendDiff"),console.log(window.performance.now()+window.performance.timing.navigationStart),f.db.upsert(f.arrangement_id,function(){return n}).then(function(){})["catch"](function(){console.log("failed to update")})},e.$watch("arrangement",function(e,t){if(e&&t&&e._rev==t._rev){var n=jsondiffpatch.diff(t,e);f.timesock||f.watchComponent(e,n)}},!0),f}]),app.directive("contenteditable",function(){return{require:"ngModel",link:function(e,t,n,o){t.bind("keydown",function(e){13===e.keyCode&&t[0].blur()}),t.bind("blur",function(){e.$apply(function(){o.$setViewValue(t.text().replace(/(\r\n|\n|\r)/gm,""))})})}}}),app.factory("DiffSyncClient",["$rootScope","jsondiffpatch","utils",function(e,t,n){var o={socket:null,syncing:!1,initialized:!1,scheduled:!1,doc:{localVersion:0,serverVersion:0,shadow:{},localCopy:{},edits:[]},commands:{syncWithServer:"send-edit",getInitialVersion:"get-latest-document-version",remoteUpdateIncoming:"updated-doc"},initializeOrSync:function(){this.isInitialized()?window.location.reload():this._id&&this.getInitialVersion()},isScheduled:function(){return this.scheduled===!0},isSyncing:function(){return this.syncing===!0},isInitialized:function(){return this.initialized===!0},getInitialVersion:function(){if(void 0===this._id)throw new Error("An `id` needs to be specified when syncing a model!");return this.isSyncing()?!1:(this.syncing=!0,void this.socket.emit(this.commands.getInitialVersion,this._id,this._setUpLocalVersion.bind(this)))},_setUpLocalVersion:function(t){this.syncing=!1,this.doc.localCopy=n.deepCopy(t.doc),this.doc.shadow=n.deepCopy(t.doc),this.doc.serverVersion=t.version,this.initialized=!0,e.$emit("sync"),this.socket.on(this.commands.remoteUpdateIncoming,this.syncWithServer.bind(this)),this.socket.on("error",function(){window.location.reload()})},syncWithServer:function(){if(this.isSyncing()||!this.isInitialized())return!1;this.syncing=!0;var e=this.createDiff(n.deepCopy(this.doc.shadow),n.deepCopy(this.doc.localCopy)),t=this.doc.localVersion;_.isEmpty(e)||this.addEdit(e,t);var o=this.createEditMessage(t);return this.applyPatchTo(this.doc.shadow,e),this.sendEdits(o),!0},createDiff:function(e,n){return t.diff(e,n)},applyPatchTo:function(e,n){t.patch(e,n)},addEdit:function(e,t){this.doc.edits.push({serverVersion:this.doc.serverVersion,localVersion:t,diff:e}),this.doc.localVersion++},createEditMessage:function(e){return{id:this.doc.localCopy._id,edits:this.doc.edits,localVersion:e,serverVersion:this.doc.serverVersion}},sendEdits:function(e){this.socket.emit(this.commands.syncWithServer,e,function(e){this.applyServerEdits(e)}.bind(this))},applyServerEdits:function(e){e&&e.localVersion==this.doc.localVersion?(this.doc.edits=[],e.edits.forEach(this.applyServerEdit.bind(this))):console.log("rejected patch because localVersions don't match"),this.syncing=!1,this.scheduled=!1},applyServerEdit:function(t){t.localVersion==this.doc.localVersion&&t.serverVersion==this.doc.serverVersion?(this.applyPatchTo(this.doc.shadow,t.diff),_.isEmpty(t.diff)||this.doc.serverVersion++,this.applyPatchTo(this.doc.localCopy,n.deepCopy(t.diff)),e.$emit("sync")):console.log("patch from server rejected, due to not matching version numbers")},scheduleSync:function(){this.isScheduled()||(1==this.scheduled,this.syncWithServer())}};return o.socket=io.connect(),o.socket.on("connect",o.initializeOrSync.bind(o)),o.syncWithServer=_.debounce(o.syncWithServer.bind(o),50),setInterval(o.scheduleSync.bind(o),5e3),window.client=o,o}]),app.directive("draggableEditorElement",function(){return{restrict:"A",link:function(e,t){var n=function(n){1==n.which&&(angular.element(document).one("mouseup",r),angular.element(document).bind("mousemove",o),e.lastX=e.startX=n.x,e.lastY=e.startY=n.y,t.triggerHandler("drag-start"))},o=function(n){n.preventDefault(),n.stopPropagation(),e.currentX=n.x;var o=e.currentX-e.lastX;e.currentY=n.y;var r=e.currentY-e.lastY;return e.lastX=e.currentX,e.dragXDiff=e.currentX-e.startX,e.lastY=e.currentY,e.dragYDiff=e.currentY-e.startY,t.triggerHandler("drag",[o,r]),!1},r=function(e){return e.stopPropagation(),e.preventDefault(),t.triggerHandler("drag-end"),angular.element(document).unbind("mousemove",o),!1};t.bind("mousedown",n)}}}),app.service("Drumkits",["BufferLoader","SharedAudioContext","$rootScope",function(e,t,n){var o={},r=[],i=t.getContext(),a=function(){r.forEach(function(e){try{e.disconnect(),e.stop()}catch(t){console.log(t)}}),r=[]};return n.$on("stop",a),n.$on("force-stop",a),{loadKit:function(t){return e.load(this.kits[t]).then(function(e){o[t]=e})},getKit:function(e){return o[e]},noop:function(){return{stop:function(){}}},play:function(e,t,n,o,a,c){o||(o=0),a||(a=0);var s=i.createBufferSource(),d=this.getKit(e);if(!d)return this.noop();s.buffer=d,s.connect(n);var l=this.kits[e].instruments[t];if(!l)return this.noop();var u=l[1]-l[0];return o=void 0!=c?c:i.currentTime+o,s.start(o,l[0],u),r.push(s),s},instrumentsForKit:function(e){return Object.keys(this.kits[e].instruments)},kits:{regular:{location:"dist/sounds/drumkits/regular.wav",instruments:{bass:[0,.522],kick:[.546,1.173],snare:[1.194,1.54],"hihat-open":[1.555,2.443],"hihat-closed":[2.475,2.594]}},trap:{location:"dist/sounds/drumkits/trap.wav",instruments:{bass:[0,.626],kick:[.641,1.006],snare:[1.02,1.365],"hihat-closed":[1.38,1.535]}}}}}]),app.directive("frequencySpectrum",["$rootScope","$compile",function(){return{restrict:"A",link:function(e,t){var n=t[0].getContext("2d"),o=t[0].width,r=t[0].height,i=128,a=function(){if(e.analyser){var t=new Uint8Array(e.analyser.frequencyBinCount),c=Math.ceil(e.analyser.frequencyBinCount/o);e.analyser.smoothingTimeConstant=.7,e.analyser.getByteFrequencyData(t),n.clearRect(0,0,o,r);for(var s=0;o>s;s++){for(var d=0,l=0,u=0;c>u;u++)l+=t[s*c+u];d=l/c;var f=d/i*(r/2);n.fillRect(s,r-f,1,r-(r-f))}e.analyser&&requestAnimationFrame(a)}};a(),e.$watch("analyser",a)}}}]),app.factory("jsondiffpatch",[function(){return jsondiffpatch.config.objectHash=function(e){return e.id||JSON.stringify(e)},jsondiffpatch}]),app.factory("Ticker",["$rootScope",function(){var e=function(){this.interval=100,this.running=!1,this.callback=function(){}};return e.prototype.isRunning=function(){return this.running===!0},e.prototype.start=function(){if(!this.isRunning()){var e=function(){this.callback()}.bind(this);this.intervalHandle=setInterval(e,this.interval),this.running=!0,e()}},e.prototype.stop=function(){this.isRunning()&&(clearInterval(this.intervalHandle),this.intervalHandle=void 0,this.running=!1)},e}]),app.directive("waveForm",["$rootScope","$compile","EditorConfig",function(e,t,n){var o=function(e,t,o){var r=n.pixelsPerSecond,i=80,a=e.length()*r,c=e.buffer.getChannelData(0),s=c.length,d=Math.ceil(s/a),l=0;if(o.ignoreOffsets)a=e.buffer.duration*r,d=Math.ceil(s/a);else if(e.data.offsetStart||e.data.offsetEnd){var u=(e.data.offsetStart+e.data.offsetEnd)*e.context.sampleRate,f=e.data.offsetStart*e.context.sampleRate;d=Math.ceil((c.length-u)/a),l=Math.floor(f/d)}var p=i/2,h=t[0].getContext("2d");t.prop("width",a),t.prop("height",i),h.clearRect(0,0,a,i);for(var m,g,v,y=0;a>y;y++){m=1,g=-1;for(var w=0;d>w;w++)v=c[(y+l)*d+w],m=m>v?v:m,g=v>g?v:g;v&&h.fillRect(y,(1+m)*p,1,(g-m)*p)}};return{restrict:"A",link:function(e,t,n){var r,i,a,c={ignoreOffsets:void 0!=n.ignoreoffsets},s=function(){o(e.node,t,c),e.$emit("waveform:rendered")},d=function(){e.node&&e.node.fetch().then(function(){s(),r=e.$watch("config.pixelsPerSecond",function(e,t){e!=t&&s()}),i=e.$watch("piece.offsetStart",function(e,t){e!=t&&s()}),a=e.$watch("piece.offsetEnd",function(e,t){e!=t&&s()})})};d();var l=e.$watch("node",function(e,t){e!=t&&d()});t.on("$destroy",function(){l(),r&&r(),i&&i(),a&&a()})}}}]),app.directive("beatsGrid",["$compile","EditorConfig","Drumkits","$rootScope","Arrangement",function(e,t,n){var o=function(e){e.instruments=n.instrumentsForKit(e.piece.drumType)};return{restrict:"A",templateUrl:"partials/pieces/beats_grid.html",link:function(e,t){o(e),e.changeBeat=function(t,n,o){var t=e.node[e.currentPatternName].data.beats[t];t[n]=1==o?0:1};var n=e.$watch("piece.drumType",function(){o(e)});t.on("$destroy",function(){n()})}}}]),app.controller("BufferedPieceController",["$rootScope","$scope","BufferedNode","Arrangement",function(e,t,n,o){t.node=new n(t.piece),o.registerPiece(t.node.data.id,t.node),t.node.master=t.trackNode["in"],t.node.context=t.trackNode.context,t.edit=function(){t.addAdditionalContent('<div buffered-piece-edit class="buffered-piece-edit-container"></div>',t)},t.remove=function(){o.removePieceFromTrack(t.piece,t.track),t.node.stop()};t.$watch("piece.position",function(e,n){e!=n&&t.node.stop()})}]),app.directive("bufferedPiece",["$compile","EditorConfig","Arrangement","utils","IDGenerator",function(e,t,n,o,r){return{restrict:"E",templateUrl:"partials/pieces/buffered_piece.html",controller:"BufferedPieceController",link:function(e){e.copyPiece=function(t){if(t.shiftKey){var n=o.deepCopy(e.piece);n.position+=.2,n.id=r.generate("piece"),e.track.pieces.push(n)}}}}}]),app.controller("BufferedPieceEditController",["$rootScope","$scope","utils","EditorConfig","Arrangement","BufferedRecordingNode",function(e,t,n,o,r,i){var a=function(){void 0==t.piece.offsetStart&&(t.piece.offsetStart=0),void 0==t.piece.offsetEnd&&(t.piece.offsetEnd=0),t.leftHandle=t.piece.offsetStart/t.node.buffer.duration*100,t.rightHandle=100-t.piece.offsetEnd/t.node.buffer.duration*100,t.rangeWidth=t.node.buffer.duration*o.pixelsPerSecond};a();var c,s=t.$watch("piece.offsetStart",a),d=t.$watch("piece.offsetEnd",a),l=function(){return{offsetStart:t.node.buffer.duration*t.leftHandle/100,offsetEnd:t.node.buffer.duration-t.node.buffer.duration*t.rightHandle/100}};t.playSelection=function(){c&&c.stop();var e=l();c=new i(n.deepCopy(t.piece),t.node.buffer),c.data.offsetStart=e.offsetStart,c.data.offsetEnd=e.offsetEnd,c.play()},t.applySelection=function(){var e=l();t.piece.offsetStart=e.offsetStart,t.piece.offsetEnd=e.offsetEnd},t.tearDown=function(){c&&c.stop(),s(),d()}}]),app.directive("bufferedPieceEdit",["$compile","EditorConfig",function(){return{restrict:"A",templateUrl:"partials/pieces/buffered_piece_edit.html",controller:"BufferedPieceEditController",link:function(e,t){var n=function(){angular.element(t[0].querySelector(".curtain")).css("width",e.rangeWidth+"px")},o=e.$watch("rangeWidth",n),r=angular.element(t[0].querySelector(".curtain .left")),i=function(){var t=e.leftHandle/100*e.rangeWidth;r.css("width",t+"px")},a=e.$watch("leftHandle",i),c=angular.element(t[0].querySelector(".curtain .right")),s=function(){var t=(1-e.rightHandle/100)*e.rangeWidth;c.css("width",t+"px")},d=e.$watch("rightHandle",s);t.on("$destroy",function(){o(),a(),d(),e.tearDown()})}}}]),app.directive("draggablePiece",["$rootScope","EditorConfig",function(e,t){var n=function(e,n,o){var r=e.tone?e.tone.position:e.piece.position;o=void 0!=o?o:r*t.pixelsPerSecond,n.css("left",o+"px")};return{restrict:"A",link:function(o,r,i){r.on("drag-start",function(){o.currentLeft=parseInt(r.css("left").replace("px",""),10)}),r.on("drag",function(e,t){o.currentLeft+=t,n(o,r,o.currentLeft)}),r.on("drag-end",function(){var i=parseInt(r.css("left").replace("px",""),10)/t.pixelsPerSecond;i=Math.max(0,i),o.$apply(function(){o.tone?o.tone.position=i:o.piece&&(o.piece.position=i,e.$emit("unschedule",o.piece)),n(o,r)})}),o.$watch(i.position||"piece.position",function(){n(o,r)},!0),o.$watch("config.pixelsPerSecond",function(){n(o,r)}),n(o,r)}}}]),app.controller("DrumPieceController",["$rootScope","$scope","utils","Sampler","Arrangement","Drumkits",function(e,t,n,o,r,i){t.node=new o(t.piece),t.node.master=t.trackNode["in"],t.node.context=t.trackNode.context,i.loadKit(t.piece.drumType),r.registerPiece(t.piece.id,t.node);var a=t.$watch("piece.drumType",function(e,n){e!=n&&i.loadKit(t.piece.drumType)});e.$on("loadWatcher",function(){t.node=new o(t.piece),t.node.master=t.trackNode["in"],t.node.context=t.trackNode.context,i.loadKit(t.piece.drumType),r.registerPiece(t.piece.id,t.node)}),t.edit=function(){t.addAdditionalContent('<div drum-piece-edit class="drum-piece-edit-container"></div>',t)},t.remove=function(){a(),r.removePieceFromTrack(t.piece,t.track),t.node.stop()}}]),app.directive("drumPiece",["$rootScope","EditorConfig","Drumkits",function(e,t,n){var o=function(e,o){var r=o[0].getContext("2d"),i=e.node.length(),a=i*t.pixelsPerSecond,c=parseInt(o.prop("height")),s=n.instrumentsForKit(e.piece.drumType);o.prop("width",a),r.clearRect(0,0,a,c),r.fillStyle="#bada55";var d=0;e.piece.patternOrder.forEach(function(t){d+=e.piece.patterns[t].slots});var l=c/s.length,u=0;e.piece.patternOrder.forEach(function(n){var o=e.piece.patterns[n],i=e.node[n],a=i.secondsBetweenBeats()*t.pixelsPerSecond;s.forEach(function(e,t){o.beats[e]&&o.beats[e].forEach(function(e,n){e&&r.fillRect(u+n*a,t*l,a,l)})}),u+=o.slots*a})};return{restrict:"E",templateUrl:"partials/pieces/drum_piece.html",controller:"DrumPieceController",link:function(e,t){var n=angular.element(t[0].querySelector("canvas"));
o(e,n),e.$on("loadWatcher",function(){console.log(e.piece),o(e,n)});var r=e.$watch("config.pixelsPerSecond",function(t,r){t!=r&&o(e,n)}),i=e.$watch("piece",function(t,r){t!=r&&o(e,n)},!0);t.on("$destroy",function(){r(),i()})}}}]),app.controller("DrumPieceEditController",["$rootScope","$scope","BufferedNode","Arrangement","Drumkits","SharedAudioContext",function(e,t,n,o,r){t.avalaibleDrumkits=Object.keys(r.kits),t.currentPatternName="a",t.isCurrentPattern=function(e){return t.currentPatternName==e},t.showPart=function(e){i&&t.startStopPlayback(),t.currentPatternName=e};var i=!1;t.startStopPlayback=function(){i?(t.node[t.currentPatternName].stopLoop(),t.loopBeat=-1):(e.$emit("force-stop"),t.node[t.currentPatternName].loop(function(e){t.$apply(function(){t.loopBeat=e})})),i=!i},t.playState=function(){return i?"icon-pause":"icon-play"},t.removeFromPatternOrder=function(e){t.piece.patternOrder.splice(e,1)},t.movePatternRight=function(e){if(e>0){var n=t.piece.patternOrder[e-1];t.piece.patternOrder[e-1]=t.piece.patternOrder[e],t.piece.patternOrder[e]=n}},t.movePatternLeft=function(e){if(e<t.piece.patternOrder.length-1){var n=t.piece.patternOrder[e+1];t.piece.patternOrder[e+1]=t.piece.patternOrder[e],t.piece.patternOrder[e]=n}},t.changeSlots=function(){var e=t.node[t.currentPatternName].data,n=e.slots;r.instrumentsForKit(t.piece.drumType).forEach(function(t){var o=e.beats[t];if(o){if(o.length>n)e.beats[t]=o.slice(0,n);else if(n>o.length)for(var r=n-o.length,i=0;r>i;i++)e.beats[t].push(0)}else e.beats[t]=new Array(n)})};{var a=function(){var e=t.node[t.currentPatternName].data;r.instrumentsForKit(t.piece.drumType).forEach(function(t){if(_.isArray(e.beats[t]))for(var n=e.slots-1;n>=0;n--)void 0==e.beats[t][n]&&(e.beats[t][n]=0);else e.beats[t]=new Array(e.slots)})};t.$watch("currentPatternName",a)}t.$on("loadWatcher",a);var c=e.$on("player:play",function(){i&&t.startStopPlayback()});t.tearDown=function(){c(),i=!0,t.startStopPlayback()}}]),app.directive("drumPieceEdit",["$compile","EditorConfig",function(){return{restrict:"A",templateUrl:"partials/pieces/drum_piece_edit.html",controller:"DrumPieceEditController",link:function(e,t){t[0].querySelector(".pattern-container").addEventListener("dragstart",function(e){var t=e.target.attributes["data-pattern-name"].value;e.dataTransfer.setData("patternName",t)});var n=t[0].querySelector(".parts-order-container");n.addEventListener("dragover",function(e){return n.classList.add("drop-here"),e.preventDefault(),e.stopPropagation(),!1}),n.addEventListener("dragleave",function(){n.classList.add("drop-here")}),n.addEventListener("drop",function(t){n.classList.remove("drop-here");var o=t.dataTransfer.getData("patternName");o&&e.$apply(function(){e.piece.patternOrder.push(o)})}),t.on("$destroy",function(){console.log("destory all watchers"),e.tearDown()})}}}]),app.directive("synthesizerPieceEdit",["$compile","EditorConfig",function(){var e={65:"Cl",87:"C#l",83:"Dl",69:"D#l",68:"El",70:"Fl",84:"F#l",71:"Gl",90:"G#l",72:"Al",85:"A#l",74:"Bl",75:"Cu",79:"C#u",76:"Du",80:"D#u",186:"Eu",222:"Fu",221:"F#u",220:"Gu"},t="3";return{restrict:"A",templateUrl:"partials/pieces/synthesizer_piece_edit.html",link:function(n,o){var r=function(o){if(e[o.keyCode]){var r=e[o.keyCode].replace("l",t).replace("u",(parseInt(t,10)+1).toString());n.node.playingNotes[r]||n.node.playNote(r)}},i=function(o){if(e[o.keyCode]){var r=e[o.keyCode].replace("l",t).replace("u",(parseInt(t,10)+1).toString());n.node.playingNotes[r]&&n.node.stopNote(r)}};window.addEventListener("keydown",r),window.addEventListener("keyup",i),o.on("$destroy",function(){window.removeEventListener("keydown",r),window.removeEventListener("keyup",i)})}}}]),app.controller("SynthesizerPieceController",["$rootScope","$scope","utils","Arrangement","Synthesizer","IDGenerator","EditorConfig",function(e,t,n,o,r,i,a){t.node=new r(t.piece),t.node.master=t.trackNode["in"],t.node.context=t.trackNode.context,t.synthSettings=t.node.data.synthSettings,t.node.setup(),o.registerPiece(t.node.data.id,t.node),t.edit=function(){t.addAdditionalContent('<div synthesizer-piece-edit class="synthesizer-piece-edit-container"></div>',t)},t.remove=function(){o.removePieceFromTrack(t.piece,t.track),s()};var c=(t.$watch("piece.position",function(e,n){e!=n&&t.node.stop()}),function(){t.node.setupSettings(),t.node.wireUpNodes()}),s=function(){t.node.compressor.disconnect(),t.node.compressor=null,t.node.filter.disconnect(),t.node.filter=null,t.node.lfo.disconnect(),t.node.lfo.stop(0),t.node.lfo=null,t.node.osc1Gain.disconnect(),t.node.osc1Gain["null"],t.node.osc2Gain.disconnect(),t.node.osc2Gain["null"],t.node.osc3Gain.disconnect(),t.node.osc3Gain["null"],t.node.stop()};t.addTone=function(e,n){n.stopPropagation(),n.preventDefault();var o=i.generate("tone"),r={id:o,duration:1,note:e,position:(n.x-256)/a.pixelsPerSecond};t.piece.tones.push(r)},t.removeTone=function(e,n){n.stopPropagation(),n.preventDefault();var o=t.piece.tones.indexOf(e);o>-1&&t.piece.tones.splice(o,1)};t.$watch("piece.synthSettings",function(e,t){e!=t&&c()},!0)}]),app.directive("synthesizerPiece",["EditorConfig",function(e){var t=function(t,n){var o=n[0].getContext("2d"),r=t.data,i=t.length()*e.pixelsPerSecond,a=parseInt(n.prop("height")),c=a/t.notes.length;n.prop("width",i),o.clearRect(0,0,i,a),o.fillStyle="#bada55";t.notes.forEach(function(t,n){var i=_.where(r.tones,{note:t});i.forEach(function(t){t.position*e.pixelsPerSecond;o.fillRect(t.position*e.pixelsPerSecond,n*c,t.duration*e.pixelsPerSecond,c)})})};return{restrict:"E",templateUrl:"partials/pieces/synthesizer_piece.html",controller:"SynthesizerPieceController",link:function(e,n){var o=function(){t(e.node,n.find("canvas"))};o();var r=e.$watch("config.pixelsPerSecond",function(e,t){e!=t&&o()}),i=e.$watch("piece.tones",function(e,t){e!=t&&o()},!0);n.on("$destroy",function(){r(),i()})}}}]),app.controller("SynthesizerPieceEditController",["$rootScope","$scope","utils","Arrangement","Synthesizer",function(){}]),app.directive("synthTone",["$compile","EditorConfig",function(e,t){var n=function(e,n){e.css("width",t.pixelsPerSecond*n+"px")};return{restrict:"A",templateUrl:"partials/pieces/synth_tone.html",link:function(e,o){var r=angular.element(o[0].querySelector(".width-handle")),i=function(){n(o,e.tone.duration)};r.on("drag",function(n,o){e.tone.duration+=o/t.pixelsPerSecond,i()}),e.$watch("tone.duration",i),o.on("$destroy",function(){console.log("destory all watchers")})}}}]),app.controller("RecordingController",["$scope","SharedAudioContext","Arrangement","BufferedRecordingNode",function(e,t,n,o){var r,i,a,c,s=function(){e.recorder&&e.recorder.stop(),c.disconnect(),a.disconnect(),i.disconnect(),r.stop(),e.isRecording=!1},d=function(){e.isUploading=!1,e.uploadProgress=0,e.speakers=!1,e.analyser=null,e.showRecording=!1,e.file=null,e.recorder=null,e.recordedNode=null};e.uploadRecording=function(){e.isUploading=!0,n.uploadBuffer(e.file).then(function(){e.cancelRecording()},function(e){console.log("There was an error!",e)},function(t){e.uploadProgress=t})},e.triggerRecording=function(){e.isRecording?(e.recorder.exportWAV(function(n){e.file=n,e.file.name="new_recording_"+Date.now();var r=new FileReader;r.onload=function(){var n=this.result;t.getContext().decodeAudioData(n,function(t){e.$apply(function(){e.recordedNode=new o({},t)})})},r.readAsArrayBuffer(n)}),s()):(e.isRecording=!0,e.recorder=new Recorder(a,{workerPath:"dist/workers/recorderWorker.js"}),e.recorder.record())},e.cancelRecording=function(){s(),d(),e.removeAdditionalContent()},e.playRecording=function(){e.recordedNode&&(e.recordedNode.isPlaying()?e.recordedNode.stop():e.recordedNode.play())},e.$watch("speakers",function(){c&&(e.speakers?c.connect(t.getContext().destination):c.disconnect())}),navigator.getUserMedia({audio:!0},function(n){var o=t.getContext();r=n,i=o.createMediaStreamSource(r),a=o.createAnalyser(),i.connect(a),c=o.createGain(),c.gain.value=1,i.connect(c),e.speakers&&c.connect(o.destination),e.$apply(function(){e.analyser=a})},function(e){console.log(e),alert("We did not get access to your microphone, please reload and allow access again!")})}]),app.directive("recordingElement",function(){return{restrict:"A",templateUrl:"partials/recording/recording-element.html",controller:"RecordingController"}}),app.controller("RecordingSelectionController",["$rootScope","$scope",function(e,t){t.playSelection=function(){t.node.play()},t.uploadSelection=function(){},t.deleteRecording=function(){}}]),app.directive("recordingSelection",["$rootScope","$compile","EditorConfig","Arrangement",function(){return{restrict:"A",controller:"RecordingSelectionController",templateUrl:"recording/recording-selection.html"}}]),app.directive("duoRange",["$compile","EditorConfig",function(){return{restrict:"A",templateUrl:"partials/ui_elements/duo_range.html",link:function(e,t){var n=function(){t.css("width",e.rangeWidth+"px")};e.$watch("rangeWidth",n),n()}}}]),app.directive("duoRangeHandle",["$compile","EditorConfig",function(e,t){var n=function(e,t,n){return"right"==t?n>e.leftHandle:n<e.rightHandle};return{restrict:"A",link:function(e,o,r){var i=r.duoRangeHandle+"Handle",a=("right"==r.duoRangeHandle?"leftHandle":"rightHandle",function(){var t=e[i];void 0!=t&&o.css("left",t+"%")});a(),e.$watch(i,a),o.on("drag",function(o,a){o.preventDefault(),o.stopPropagation();var c=e[i]+a*t.pixelsPerSecond/e.rangeWidth;return c>=0&&100>=c&&n(e,r.duoRangeHandle,c)&&e.$apply(function(){e[i]=c}),!1})}}}]),app.controller("HomeController",["$rootScope","$scope","$auth","$state",function(e,t,n,o){n.isAuthenticated()&&o.go("project"),t.authenticate=function(e){n.authenticate(e).then(function(){console.log("successfully logged"),o.go("project")})["catch"](function(e){console.log("failed to log in"),console.log(e.data?e.data.message:e)})}}]),app.controller("LogoutController",["$rootScope","$scope","$auth","$state",function(e,t,n,o){n.logout().then(function(){o.go("home")})}]),app.controller("ProjectController",["$rootScope","$scope","$auth","$state","_UserDB","_SharedDB","_ArrangementDB","CouchURL","Account",function(e,t,n,o,r,i,a,c,s){n.isAuthenticated()||o.go("home");var d=new PouchDB(c+a),l=new PouchDB(c+r),u=new PouchDB(c+i);t.projects=[],t.users=[],t.add=function(){var e=prompt("Please enter your new arrangement name","New Arrangement");if(null!=e){var n=e.replace(/(^\-+|[^a-zA-Z0-9\/_| -]+|\-+$)/g,"").toLowerCase().replace(/[\/_| -]+/g,"-");d.putIfNotExists({_id:n,title:e,author:t.user.facebook,tracks:[],buffers:[]}).then(function(){t.refresh()})}},t.remove=function(e){var n=confirm("Are you sure want to remove "+e.title+"?");1==n&&d.remove(e).then(function(){t.refresh()})},t.removeShared=function(e){var n=confirm("Are you sure want to remove ?");1==n&&u.remove(e).then(function(){t.refresh()})},t.refresh=function(){var e=t.user;l.allDocs({include_docs:!0}).then(function(e){t.$apply(function(){t.users=_.map(e.rows,function(e){return e.doc})})}),u.query(function(e){emit(e.user)},{startkey:e.facebook,endkey:e.facebook,include_docs:!0}).then(function(e){t.$apply(function(){t.shared=_.map(e.rows,function(e){return e.doc})})}),d.query(function(e){emit(e.author)},{startkey:e.facebook,endkey:e.facebook,include_docs:!0}).then(function(e){t.$apply(function(){t.projects=_.map(e.rows,function(e){return e.doc})})})},s.getProfile().success(function(n){t.user=n,e.user=n,t.refresh()})}]),app.directive("time",function(){return{restrict:"A",scope:{number:"=number",format:"=format"},template:"{{formatted}}",link:function(e){e.$watch("number",function(){e.formatted=moment(e.number).fromNow()}),e.formatted=moment(e.number).fromNow()}}}),app.controller("CommunicationPanelController",["$rootScope","$scope","Arrangement","Chat","$http","$auth","Account","$stateParams",function(e,t,n,o,r,i,a,c){t.arrangement_id=c.arrangement_id,t.hideCommunicationPanel=function(){e.showCommunicationPanel=!1},a.getProfile().success(function(e){t.user=e}),t.message="",t.chats=[],o.bind(t.arrangement_id,t,"chats"),t.send=function(){var e={_id:(new Date).toISOString(),arrangement_id:t.arrangement_id,content:t.message,user:t.user,time:new Date};o.add(e),t.message=""}}]),app.directive("communicationPanel",function(){return{restrict:"A",controller:"CommunicationPanelController",templateUrl:"partials/editor/communication-panel.html",link:function(){}}}),app.service("EditorConfig",function(){return{pixelsPerSecond:50,track_settings_offset:190}}),app.controller("EditorController",["$rootScope","$scope","Arrangement","EditorConfig","Sampler","BufferedNode","$auth","Account","$stateParams","$interval","CouchURL",function(e,t,n,o,r,i,a,c,s,d,l){t.arrangement_id=s.arrangement_id,n.arrangement_id=s.arrangement_id,n.init(),t.arrangement=n.doc,t.config=o,Offline.options={checks:{xhr:{url:l}}};var u={};Offline.on("down",function(){console.log("GOING DOWN"),n.goOffline(),u=_.clone(n.doc,!0)}),Offline.on("up",function(){console.log("GOING UP"),n.goOnline();var e=_.clone(n.doc,!0),t=jsondiffpatch.diff(u,e);t&&(n.delta=t)}),t.$destroy=function(){d.cancel(run),Offline.off("down"),Offline.off("up")},t.getProfile=function(){c.getProfile().success(function(e){t.user=e}).error(function(e){console.log(e)})},e.$on("sync",function(){t.$apply(function(){t.arrangement=n.doc})}),t.getProfile()}]),app.controller("EditorControlsController",["$rootScope","$scope","Scheduler","Arrangement","FileBrowser","$state",function(e,t,n,o,r,i){e.showCommunicationPanel=!1,e.showSharePanel=!1,t.playing=!1,t.arrangement=o.doc,t.gain=1,t.isPlaying=function(){return t.playing?"icon-pause":"icon-play"},t.playPause=function(){t.playing?this.pause():this.play()},t.play=function(){t.playing=!0,n.start()},t.pause=function(){t.playing=!1,n.pause()},t.stop=function(){t.playing=!1,e.$emit("stop"),n.stop()},t.addTrack=function(e){t.showMenu=!1,o.addTrack(e)},t.showFiles=function(){r.show()},t.hideFiles=function(){r.hide()},t.isFileBrowserVisible=function(){return r.isVisible()},t.showCommunication=function(){e.showCommunicationPanel=!0},t.showShare=function(){e.showSharePanel=!0},t.backProject=function(){i.go("project")},t.isCommunicationPanelVisible=function(){return e.showCommunicationPanel===!0},t.isSharePanelVisible=function(){return e.showSharePanel===!0},t.$watch("gain",function(){o.master.gain.value=t.gain}),e.$on("force-stop",function(){t.stop()})}]),app.directive("editorControls",["$templateCache",function(){return{restrict:"E",templateUrl:"partials/editor/controls.html",controller:"EditorControlsController"}}]),app.directive("editorTracks",function(){return{restrict:"E",templateUrl:"partials/editor/tracks.html"}}),app.controller("EditorTrackController",["$rootScope","$scope","Track","Arrangement","IDGenerator",function(e,t,n,o,r){t.trackNode=new n(t.track),t.muted=!1,t.solo=!1,t.$watch("track.gain",function(e){t.trackNode["in"].gain.value=parseFloat(e,10)}),e.$on("soloed-track",function(e,n){n!=t&&(t.solo=!1,t.trackNode["in"].gain.value=0)}),e.$on("un-soloed-track",function(){t.muted||(t.trackNode["in"].gain.value=t.track.gain)}),t.toggleMute=function(){t.muted?t.unMuteTrack():t.muteTrack()},t.unMuteTrack=function(){t.muted=!1,t.trackNode["in"].gain.value=t.track.gain},t.muteTrack=function(){t.muted=!0,t.solo=!1,t.trackNode["in"].gain.value=0},t.toggleSolo=function(){t.solo?t.unSoloTrack():t.soloTrack()},t.soloTrack=function(){t.solo=!0,t.unMuteTrack(),e.$broadcast("soloed-track",t)},t.unSoloTrack=function(){t.solo=!1,e.$broadcast("un-soloed-track",t)},t.uploadFile=function(e,n){o.uploadBufferAndAddToTrack(e,t.track.id,n)},t.addBuffer=function(e,n){o.addBufferToTrack(e,t.track.id,n)},t.addPiece=function(){switch(t.track.type){case"synthesizer":t.track.pieces.push({type:"synthesizer",position:0,id:r.generate("synthesizer"),tones:[],synthSettings:{osc1:{type:"square",gain:1,detune:0},osc2:{type:"sine",gain:1,detune:0},osc3:{type:"triangle",gain:.5,detune:0},lfo:{type:"sine",frequency:0},toneEnvelope:{attack:0,decay:0,sustain:1,release:0,boost:0},filter:{frequency:0,Q:0,gain:1,detune:0,type:"lowpass",activate:!1}}});break;case"drums":t.track.pieces.push({type:"drum",drumType:"trap",position:0,id:r.generate("drums"),instruments:["hihat-closed","bass","snare"],patternOrder:["a"],patterns:{a:{slots:16,bpm:100,beats:{}},b:{slots:16,bpm:100,beats:{}},c:{slots:16,bpm:100,beats:{}},d:{slots:16,bpm:100,beats:{}},e:{slots:16,bpm:100,beats:{}},f:{slots:16,bpm:100,beats:{}}}});break;case"recording":t.addAdditionalContent('<div recording-element ng-model="track"></div>',t)}},t.addRecordingElement=function(){t.addAdditionalContent('<div recording-element ng-model="track"></div>',t)},t.removeTrack=function(){if(confirm("Do you really want to remove this track? ("+t.track.title+")")){var e=t.arrangement.tracks.indexOf(t.track);e>-1&&t.arrangement.tracks.splice(e,1)}}}]),app.directive("editorTrack",["$rootScope","$compile","EditorConfig","Arrangement",function(e,t,n){return{restrict:"E",controller:"EditorTrackController",templateUrl:"partials/editor/track.html",link:function(e,o){var r=o[0].querySelector(".track");r.addEventListener("dragenter",function(e){return r.classList.add("drop-here"),e.preventDefault(),e.stopPropagation(),!1}),r.addEventListener("dragover",function(e){return r.classList.add("drop-here"),e.preventDefault(),e.stopPropagation(),!1}),r.addEventListener("dragleave",function(e){return r.classList.remove("drop-here"),e.preventDefault(),e.stopPropagation(),!1}),r.addEventListener("drop",function(t){r.classList.remove("drop-here");var o=(t.x-n.track_settings_offset)/n.pixelsPerSecond,i=t.dataTransfer.getData("buffer_id");return i?e.addBuffer(i,o):e.uploadFile(t.dataTransfer.files.item(0),o),t.preventDefault(),t.stopPropagation(),!1});var i=function(){return angular.element(document.getElementById("additional-content-"+e.track.id))};e.addAdditionalContent=function(n,o){var r=t(n)(o),i=e.removeAdditionalContent(),a='<div class="additional-content-controls"><button class="topcoat-button" ng-click="removeAdditionalContent()">close</button></div>',a=t(a)(o);i.append(r),i.append(a)},e.removeAdditionalContent=function(){var e=i();return e.html(""),e}}}}]),app.service("FileBrowser",["$rootScope",function(){var e=!1,t="";return{show:function(){e=!0},setActiveFile:function(e){t=e},hide:function(){e=!1,t=""},isVisible:function(){return 1==e},activeFileName:function(){return t}}}]),app.controller("FileBrowserController",["$rootScope","$scope","Arrangement","FileBrowser",function(e,t,n,o){e.$on("synced",function(){t.files=n.doc.buffers}),t.removeBuffer=function(e){n.removeBuffer(e)},t.hideFileBrowser=function(){o.hide()},t.isActiveFile=function(e){return o.activeFileName()==e}}]),app.directive("fileBrowser",function(){return{restrict:"A",controller:"FileBrowserController",templateUrl:"partials/editor/file-browser.html",link:function(e,t){t[0].addEventListener("dragstart",function(e){var t=e.target.attributes["data-buffer-id"].value;e.dataTransfer.setData("buffer_id",t)})}}}),app.directive("progressLine",["$rootScope","Scheduler","EditorConfig","Arrangement",function(e,t,n,o){var r=function(e){var o=t.songPosition*n.pixelsPerSecond+n.track_settings_offset;e.removeClass("animated").css("transitionDuration","0s"),_.defer(function(){e.css("left",o+"px")})},i=function(e){for(var n=0,i=document.querySelectorAll(".piece"),a=0;a<i.length;a++){var c=i[a],s=c.getBoundingClientRect(),d=s.left+s.width;n=d>n?d:n}var l=o.length()-t.songPosition;r(e),_.defer(function(){e.addClass("animated").removeClass("notAnimated").css({transitionDuration:l+"s",left:n+"px"}).one("transitionend",function(){e.removeClass("animated").addClass("notAnimated")})})},a=function(e){r(e)};return{restrict:"E",template:'<div id="progress-line"></div>',link:function(t){var n=angular.element(document.getElementById("progress-line"));r(n),e.$on("player:play",function(){i(n)}),e.$on("player:pause",function(){a(n)}),e.$on("player:stop",function(){a(n)}),e.$on("player:position-change",function(){a(n)}),t.$watch("config.pixelsPerSecond",function(){r(n)})}}}]),app.service("Scheduler",["$rootScope","Ticker","Arrangement",function(e,t,n){var o={playing:!1,startedAt:null,stoppedAt:null,from:0,songPosition:0,_scheduledPieces:{},start:function(t){this.playing=!0,t=t||this.songPosition,this.startedAt=Date.now(),this.from=t,this.schedule(),this.ticker.start(),e.$emit("player:play")},pause:function(t){this.playing=!1,this.stoppedAt=Date.now(),this.songPosition+=this.lastDuration(),this.ticker.stop(),this.unschedulePieces(),t||e.$emit("player:pause")},stop:function(t){this.playing=!1,this.pause(!0),this.songPosition=0,t||e.$emit("player:stop")},setSongPosition:function(t){var n=this.playing;console.log("songPosition",this.songPosition),this.stop(!0),this.songPosition=t,e.$emit("player:position-change"),n&&this.start()},lastDuration:function(){return(this.stoppedAt-this.startedAt)/1e3},_delta:function(){return(Date.now()-this.startedAt)/1e3},_position:function(){return this._delta()+this.from},schedule:function(){var e=this._position(),t=this.lookAhead,o=0,r=!1,i=!1;n.doc.tracks.forEach(function(n){n.pieces&&0!=n.pieces.length&&n.pieces.forEach(function(n){if(o=n.position,r=o>e&&e+t>=o,i=e>=o&&e<o+this.lengthForPiece(n),(r||i)&&!this.hasBeenScheduled(n)){var a=Math.max(o-e,0),c=Math.max(e-o,0);this.schedulePiece(n,a,c)}}.bind(this))}.bind(this))},schedulePiece:function(e,t,o){var e=n.getPiece(e.id);e.play(t,o),this._scheduledPieces[e.data.id]=e,console.log("schedule:piece:"+e.data.id,t,o)},unschedulePieces:function(){Object.keys(this._scheduledPieces).forEach(function(e){this._scheduledPieces[e]&&this._scheduledPieces[e].stop&&this._scheduledPieces[e].stop()}.bind(this)),this._scheduledPieces={}},hasBeenScheduled:function(e){return this._scheduledPieces[e.id]},lengthForPiece:function(e){var e=n.getPiece(e.id);return e?e.length():0}},r=new t;return r.callback=o.schedule.bind(o),o.ticker=r,o.lookAhead=3*r.interval/1e3,e.$on("unschedule",function(e,t){o._scheduledPieces[t.id]=!1}),o}]),app.controller("SharePanelController",["$rootScope","$scope","Arrangement","Chat","$http","$auth","Account","$stateParams","_SharedDB","_UserDB","_ArrangementDB","CouchURL",function(e,t,n,o,r,i,a,c,s,d,l,u){t.arrangement_id=c.arrangement_id;var f=new PouchDB(u+s),p=new PouchDB(u+d);t.shared=[],t.users=[],t.hideSharePanel=function(){e.showSharePanel=!1},t.add=function(e){f.post({title:n.doc.title,arrangement:n.doc._id,user:e.facebook,profile:e}).then(function(){t.refresh()})},t.remove=function(e){var n=confirm("Are you sure want to remove ?");1==n&&f.remove(e).then(function(){t.refresh()})},t.refresh=function(){f.query(function(e){emit(e.arrangement)},{startkey:t.arrangement_id,endkey:t.arrangement_id,include_docs:!0}).then(function(e){t.$apply(function(){t.shared=_.map(e.rows,function(e){return e.doc})})}),p.allDocs({include_docs:!0}).then(function(e){t.$apply(function(){t.users=_.map(e.rows,function(e){return e.doc})})})},a.getProfile().success(function(e){t.user=e}),t.refresh()}]),app.directive("sharePanel",function(){return{restrict:"A",controller:"SharePanelController",templateUrl:"partials/editor/share-panel.html",link:function(){}}}),app.directive("timeLine",["$rootScope","Arrangement","EditorConfig","Scheduler",function(e,t,n,o){var r="#888",i=15,a=function(e){var o=e[0].getContext("2d"),a=t.length(),c=n.pixelsPerSecond,s=c*a;e.prop("width",s),e.prop("height",i),o.clearRect(0,0,s,e.prop("height")),o.fillStyle=r;for(var d=0;a>=d;d++)o.fillRect(d*c,0,1,i),o.fillRect((d+.5)*c,0,1,i/2)},a=_.debounce(a,1e3),c=function(e,t){var r=t[0].getBoundingClientRect(),i=(e.x-r.left)/n.pixelsPerSecond;o.setSongPosition(i)};return{restrict:"E",template:'<div class="time-line"><canvas height="'+i+'"></canvas></div>',link:function(t,n){var o=n.find("canvas");a(o),t.$watch("config.pixelsPerSecond",function(e,t){e!=t&&a(o)}),e.$on("bufferloader:loaded",function(){a(o)}),n.on("click",function(e){c(e,o)})}}}]),app.service("BufferLoader",["$q","$rootScope","SharedAudioContext","AudioCache",function(e,t,n,o){return{_cache:{},_deferreds:{},load:function(t){var n=t.location;if(this._cache[n]){var o=e.defer();return o.resolve(this._cache[n]),o.promise}return this._deferreds[n]?this._deferreds[n].promise:this._load(n)},_load:function(t){var n=e.defer();this._deferreds[t]=n;var o=new XMLHttpRequest;return o.open("GET",t,!0),o.responseType="arraybuffer",o.addEventListener("error",this._transferFailed(t,n),!1),o.addEventListener("load",this._transferComplete(t,n),!1),o.onload=function(){this._decodeAudio(o.response,n,t)}.bind(this),o.send(),n.promise},_transferFailed:function(e,t){var n=this,r=e.split("/");o.getCache(r[3]).then(function(o){n._decodeAudio(o,t,e)})},_transferComplete:function(e){var t=e.split("/");o.putCache(e,t[3])},_decodeAudio:function(e,o,r){n.getContext().decodeAudioData(e,function(e){this._deferreds[r]=void 0,this._cache[r]=e,o.resolve(e),t.$emit("bufferloader:loaded",e)}.bind(this),function(e){o.reject("Error decoding file",e)})}}}]),app.factory("BufferUploader",["$q","$rootScope","IDGenerator",function(e,t,n){return{_deferreds:{},_requests:{},supportsUploadOf:function(e){return e.type&&("audio/mp3"==e.type||"audio/wav"==e.type||"audio/ogg"==e.type)},upload:function(t,n){if(!this.supportsUploadOf(n)){var o=e.defer();return o.reject("Wrong filetype! "+n.type),o.promise}var r=n.name;return this._deferreds[r]?this._deferreds[r].promise:this._upload(t,n)},_upload:function(t,o){var r=o.name,i=[t,n.generate("buffer"),r].join("___"),a=e.defer();this._deferreds[r]=a;var c=this,s=new S3Upload({s3_object_name:i,s3_sign_put_url:"/sign_s3",onProgress:function(e,t){console.log("Upload progress: "+e+"% "+t),a.notify(e)},onFinishS3Put:function(e){c._uploadComplete(e,a,r,i),console.log("uploaddone",e)},onError:function(e){console.log("error","upload",e)}});return s.uploadFile(o),this._requests[r]=s,a.promise},_uploadComplete:function(e,n,o,r){delete this._requests[o],delete this._deferreds[o];var i={id:r,location:e,name:o};t.$emit("bufferuploader:done"),n.resolve(i)},totalFiles:function(){}}}]),app.service("IDGenerator",function(){return{generate:function(e){var t=e?e+"_":"",n=Date.now(),o=999999*Math.random();return t+=Math.random()*n*o}}}),app.factory("SharedAudioContext",[function(){var e;return{getContext:function(){return e||(e=new AudioContext),e}}}]),window.AudioContext=window.AudioContext||window.webkitAudioContext,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,app.factory("utils",[function(){return{deepCopy:function(e){return JSON.parse(JSON.stringify(e))}}}]),app.factory("Account",["$http",function(e){return{getProfile:function(){return e.get("/api/me")},updateProfile:function(t){return e.put("/api/me",t)}}}]),app.service("AudioCache",["$http","$q",function(e,t){var n=this;return window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,n.filesystem=null,n.errorHandler=function(e){var t="";switch(e.code){case FileError.SECURITY_ERR:t="Security Error";break;case FileError.NOT_FOUND_ERR:t="Not Found Error";break;case FileError.QUOTA_EXCEEDED_ERR:t="Quota Exceeded Error";break;case FileError.INVALID_MODIFICATION_ERR:t="Invalid Modification Error";break;case FileError.INVALID_STATE_ERR:t="Invalid State Error";break;default:t="Unknown Error"}console.log(t)},n.initFileSystem=function(){navigator.webkitPersistentStorage.requestQuota(5242880,function(e){window.requestFileSystem(window.PERSISTENT,e,function(e){n.filesystem=e},n.errorHandler)},n.errorHandler)},n.downloadFile=function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.onload=function(){t(n.response)},n.send(null)},n.saveFile=function(e,t){null!==n.filesystem&&n.filesystem.root.getFile(e,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){console.log("cache saved")},e.onerror=function(e){console.log("Write error: "+e.toString()),alert("An error occurred and your file could not be saved!")};for(var n=t,o=n.length,r=new ArrayBuffer(o),i=new Uint8Array(r),a=0;o>a;a++)i[a]=255&n.charCodeAt(a);var c=new Blob([i],{type:"audio/wav"});e.write(c)},n.errorHandler)},n.errorHandler)},n.loadFile=function(e,t){null!==n.filesystem&&n.filesystem.root.getFile(e,{},function(e){e.file(function(e){var n=new FileReader;n.onload=function(){t(this.result)},n.readAsArrayBuffer(e)},n.errorHandler)},n.errorHandler)},n.getCache=function(e){var o=t.defer();return n.loadFile(e,function(e){o.resolve(e)}),o.promise},n.putCache=function(e,t){n.downloadFile(e,function(e){n.saveFile(t,e)})},window.requestFileSystem?n.initFileSystem():alert("Sorry! Your browser doesn't support the FileSystem API :("),n}]),app.factory("Chat",["CouchURL","_ChatDB",function(e,t){var n=e+t,o=new PouchDB(t),r={live:!0,retry:!0},i=this;return i.scope={},i.name="",i.arrangement="",i.syncing=function(){""!=i.arrangement&&o.query(function(e,t){t(e.arrangement_id)},{startkey:i.arrangement,endkey:i.arrangement,include_docs:!0}).then(function(e){i.scope.$apply(function(){i.scope[i.name]=_.map(e.rows,function(e){return e.doc})})})},o.sync(n,r),o.changes({since:"now",live:!0}).on("change",i.syncing),{add:function(e){console.log(e),i.scope[i.name].push(e),o.put(e).then(function(){})},bind:function(e,t,n){i.scope=t,i.name=n,i.arrangement=e,i.syncing()}}}]),app.factory("Socket",["$rootScope","IDGenerator","$timeout",function(e,t,n){var o=this;return o.socket=io(),o.arrangement={},o.currentTrack="",o.update=function(){e.$apply(function(){e.arrangement=o.arrangement.doc}),e.$emit("sync"),e.$emit("synced"),e.$emit("loadWatcher")},o.socket.on("addTrack",function(){o.arrangement.addTrack("drums",function(e){o.currentTrack=e}),console.log("::DEBUG:: addTrack"),console.log(window.performance.now()+window.performance.timing.navigationStart),o.update()}),o.socket.on("movePiece",function(){n(function(){console.log(o.currentTrack);var e=_.findWhere(o.arrangement.doc.tracks,{id:o.currentTrack});if(e){var t=Math.floor(Math.random()*e.pieces.length+1)-1,n=Math.floor(10*Math.random()+1);e.pieces[t].position=n}console.log("::DEBUG:: movePiece"),console.log(window.performance.now()+window.performance.timing.navigationStart),o.update()})}),o.socket.on("addPiece",function(){n(function(){console.log(o.currentTrack);var e=_.findWhere(o.arrangement.doc.tracks,{id:o.currentTrack});e&&e.pieces.push({type:"drum",drumType:"trap",position:0,id:t.generate("drums"),instruments:["hihat-closed","bass","snare"],patternOrder:["a"],patterns:{a:{slots:16,bpm:100,beats:{}},b:{slots:16,bpm:100,beats:{}},c:{slots:16,bpm:100,beats:{}},d:{slots:16,bpm:100,beats:{}},e:{slots:16,bpm:100,beats:{}},f:{slots:16,bpm:100,beats:{}}}}),console.log("::DEBUG:: addPiece"),console.log(window.performance.now()+window.performance.timing.navigationStart),o.update()})}),o.socket.on("changeTitle",function(){n(function(){var e=_.findWhere(o.arrangement.doc.tracks,{id:o.currentTrack});console.log(e),e&&(e.title=o.currentTrack),console.log("::DEBUG:: changeTitle"),console.log(window.performance.now()+window.performance.timing.navigationStart),o.update()})}),o}]);var recLength=0,recBuffersL=[],recBuffersR=[],sampleRate;this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type);break;case"getBuffer":getBuffer();break;case"clear":clear()}};